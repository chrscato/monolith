<!-- billing/webapp/bill_review/templates/bill_review/bill_detail.html -->
{% extends "base.html" %}
{% load widget_tweaks %}

{% block extra_css %}
<style>
/* Mobile-specific modal improvements */
@media (max-width: 768px) {
    .modal-dialog {
        margin: 0.5rem;
        max-width: calc(100% - 1rem);
        max-height: calc(100vh - 1rem);
    }
    
    .modal-content {
        max-height: calc(100vh - 1rem);
        overflow-y: auto;
    }
    
    .modal-body {
        padding: 1rem;
    }
    
    .modal-footer {
        padding: 0.75rem 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .modal-footer .btn {
        flex: 1;
        min-width: 120px;
    }
    
    /* Improve table responsiveness on mobile */
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .table th, .table td {
        padding: 0.5rem 0.25rem;
        white-space: nowrap;
    }
    
    /* Make action buttons more touch-friendly */
    .btn-group .btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }
    
    /* Stack buttons vertically on very small screens */
    @media (max-width: 576px) {
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .btn-group .btn {
            width: 100%;
        }
    }
}

/* Ensure modals are always accessible */
.modal {
    z-index: 1055;
}

.modal-backdrop {
    z-index: 1050;
}

/* Improve form layout on mobile */
@media (max-width: 768px) {
    .form-label {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .form-control, .form-select {
        margin-bottom: 1rem;
    }
    
    .modal-body .row {
        margin: 0;
    }
    
    .modal-body .col-md-6 {
        padding: 0;
        margin-bottom: 0.5rem;
    }
}

/* Existing styles */
.table-responsive {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

.comparison-highlight {
    background-color: #fff3cd !important;
    animation: highlight-pulse 2s ease-in-out;
}

@keyframes highlight-pulse {
    0%, 100% { background-color: #fff3cd; }
    50% { background-color: #ffeaa7; }
}

.table-bordered td, .table-bordered th {
    border-width: 1px;
}

.table th {
    font-size: 0.875rem;
    font-weight: 600;
}

.table td {
    font-size: 0.875rem;
    vertical-align: middle;
}

.badge {
    font-size: 0.75rem;
}

.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle deny reason selection
    const denyReason = document.getElementById('denyReason');
    const denyAction = document.getElementById('denyAction');
    
    denyReason.addEventListener('change', function() {
        if (this.value === 'CO-50 - These are non-covered services') {
            denyAction.value = 'deny-CO-50';
        } else if (this.value === 'Claim not found in FileMaker') {
            denyAction.value = 'deny-not a cdx claim';
        } else {
            denyAction.value = '';
        }
    });
    
    // Mobile-specific modal improvements
    function improveModalMobile() {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.addEventListener('show.bs.modal', function() {
                // Ensure modal is properly positioned on mobile
                if (window.innerWidth <= 768) {
                    this.style.display = 'block';
                    this.style.paddingLeft = '0px';
                    this.style.paddingRight = '0px';
                }
            });
            
            modal.addEventListener('shown.bs.modal', function() {
                // Scroll to top of modal content on mobile
                if (window.innerWidth <= 768) {
                    const modalContent = this.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.scrollTop = 0;
                    }
                }
            });
        });
    }
    
    improveModalMobile();
    
    // Handle window resize
    window.addEventListener('resize', function() {
        improveModalMobile();
    });
});
</script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Action Buttons -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Bill Details</h1>
        <div class="d-flex gap-2">
            <a href="{% url 'bill_review:dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <a href="{% url 'bill_review:view_bill_pdf' bill.id %}" class="btn btn-info" target="_blank">
                <i class="fas fa-file-pdf"></i> View PDF
            </a>
            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#escalateModal">
                <i class="fas fa-exclamation-triangle"></i> ESCALATE
            </button>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveModal">
                <i class="fas fa-check-circle"></i> APPROVE
            </button>
            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#denyModal">
                <i class="fas fa-ban"></i> DENY
            </button>
            <form method="post" action="{% url 'bill_review:reset_bill' bill.id %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" name="reset_bill" class="btn btn-warning" onclick="return confirm('Reset this bill to MAPPED status?')">
                    Reset to MAPPED
                </button>
            </form>
            <form method="post" action="{% url 'bill_review:update_bill' bill.id %}" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="status" value="GARBAGE">
                <input type="hidden" name="action" value="">
                <input type="hidden" name="last_error" value="not a bill">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to mark this bill as garbage?')">
                    <i class="fas fa-trash"></i> GARBAGE
                </button>
            </form>
        </div>
    </div>

    <!-- Escalate Modal -->
    <div class="modal fade" id="escalateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'bill_review:update_bill' bill.id %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">Escalate Bill</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="escalateMessage" class="form-label">Escalation Message</label>
                            <textarea class="form-control" id="escalateMessage" name="last_error" rows="3" required></textarea>
                        </div>
                        <input type="hidden" name="status" value="ESCALATE">
                        <input type="hidden" name="action" value="resolve_escalation">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Escalate</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Approve Modal -->
    <div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'bill_review:update_bill' bill.id %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">Approve Bill</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Select Approval Type</label>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-outline-success" name="action" value="review_rate">
                                    <i class="fas fa-calculator"></i> Approve to Apply Rate
                                </button>
                                <button type="submit" class="btn btn-outline-success" name="action" value="apply_rate">
                                    <i class="fas fa-file-invoice"></i> Approve for EOBR
                                </button>
                            </div>
                        </div>
                        <input type="hidden" name="status" value="REVIEWED">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Deny Modal -->
    <div class="modal fade" id="denyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Deny Bill</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'bill_review:update_bill' bill.id %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="denyReason" class="form-label">Denial Reason</label>
                            <select class="form-select" id="denyReason" name="last_error" required>
                                <option value="">Select a reason...</option>
                                <option value="CO-50 - These are non-covered services">CO-50 - These are non-covered services</option>
                                <option value="Claim not found in FileMaker">Claim not found in FileMaker</option>
                            </select>
                        </div>
                        <input type="hidden" name="status" value="DENIED">
                        <input type="hidden" name="action" id="denyAction" value="">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Deny</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Alert for Arthrogram -->
    {% if is_arthrogram %}
    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle"></i> This is an arthrogram procedure.
    </div>
    {% endif %}

    <!-- CPT Code Comparison -->
    {% if billed_not_ordered or ordered_not_billed %}
    <div class="alert alert-warning mb-4">
        <h5 class="alert-heading">CPT Code Discrepancies</h5>
        {% if billed_not_ordered %}
        <p class="mb-1"><strong>Billed but not ordered:</strong></p>
        <ul class="mb-2">
            {% for cpt in billed_not_ordered %}
            <li>{{ cpt }} {% if cpt in cpt_categories %}({{ cpt_categories.cpt.category }}){% endif %}</li>
            {% endfor %}
        </ul>
        {% endif %}
        {% if ordered_not_billed %}
        <p class="mb-1"><strong>Ordered but not billed:</strong></p>
        <ul class="mb-0">
            {% for cpt in ordered_not_billed %}
            <li>{{ cpt }} {% if cpt in cpt_categories %}({{ cpt_categories.cpt.category }}){% endif %}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    {% endif %}

    <!-- Units Violations -->
    {% if units_violations %}
    <div class="alert alert-danger mb-4">
        <h5 class="alert-heading">Units Violations</h5>
        <ul class="mb-0">
            {% for violation in units_violations %}
            <li>CPT {{ violation.cpt }} has {{ violation.units }} units</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Main Accordion -->
    <div class="accordion mb-4" id="billAccordion">
        <!-- Bill Information -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#billInfo">
                    Bill Information
                </button>
            </h2>
            <div id="billInfo" class="accordion-collapse collapse show" data-bs-parent="#billAccordion">
                <div class="accordion-body">
                    <!-- Patient Name Section (separate form) -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Patient Name</label>
                                <form method="post" action="{% url 'bill_review:update_patient_name' bill.id %}" class="d-flex gap-2 align-items-end">
                                    {% csrf_token %}
                                    <input type="text" name="patient_name" class="form-control" value="{{ bill.patient_name }}" placeholder="Enter patient name">
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="fas fa-save"></i> Save
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main Bill Update Form -->
                    <form method="post" action="{% url 'bill_review:update_bill' bill.id %}">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Bill ID</label>
                                    <input type="text" class="form-control" value="{{ bill.id }}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Claim ID</label>
                                    <input type="text" class="form-control" value="{{ bill.claim_id }}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    {{ form.status|add_class:"form-select" }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Action</label>
                                    {{ form.action|add_class:"form-select" }}
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Error Message</label>
                                    {{ form.last_error|add_class:"form-control" }}
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Created At</label>
                                    <input type="text" class="form-control" value="{{ bill.created_at|date:'Y-m-d H:i' }}" readonly>
                                </div>
                            </div>
                        </div>
                        <button type="submit" name="update_bill" class="btn btn-primary">Update Bill</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Order Mapping Section -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="mappingHeader">
                <button class="accordion-button {% if not search_results and not auto_searched %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#mappingCollapse" aria-expanded="{% if search_results or auto_searched %}true{% else %}false{% endif %}">
                    <i class="fas fa-link me-2"></i>Order Mapping
                </button>
            </h2>
            <div id="mappingCollapse" class="accordion-collapse collapse {% if search_results or auto_searched %}show{% endif %}" aria-labelledby="mappingHeader">
                <div class="accordion-body">
                    <!-- Mapping Form -->
                    <form method="post" class="mb-4">
                        {% csrf_token %}
                        <div class="row g-3">
                            <!-- Patient Last Name Field -->
                            <div class="col-12">
                                <div class="form-floating">
                                    {{ mapping_form.patient_last_name }}
                                    <label for="{{ mapping_form.patient_last_name.id_for_label }}">Patient Last Name</label>
                                </div>
                                {% if mapping_form.patient_last_name.help_text %}
                                    <div class="form-text">{{ mapping_form.patient_last_name.help_text }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Patient First Name Field -->
                            <div class="col-12">
                                <div class="form-floating">
                                    {{ mapping_form.patient_first_name }}
                                    <label for="{{ mapping_form.patient_first_name.id_for_label }}">Patient First Name</label>
                                </div>
                                {% if mapping_form.patient_first_name.help_text %}
                                    <div class="form-text">{{ mapping_form.patient_first_name.help_text }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Date Range Fields -->
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ mapping_form.date_from }}
                                    <label for="{{ mapping_form.date_from.id_for_label }}">Date From</label>
                                </div>
                                {% if mapping_form.date_from.help_text %}
                                    <div class="form-text">{{ mapping_form.date_from.help_text }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ mapping_form.date_to }}
                                    <label for="{{ mapping_form.date_to.id_for_label }}">Date To</label>
                                </div>
                                {% if mapping_form.date_to.help_text %}
                                    <div class="form-text">{{ mapping_form.date_to.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Optional Date Fields Info -->
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Date fields are optional. If not provided, the search will look for orders within the last 30 days.
                        </div>
                        
                        <div class="mt-3">
                            <button type="submit" name="search_orders" class="btn btn-primary">
                                <i class="fas fa-search me-2"></i>Search Orders
                            </button>
                        </div>
                    </form>

                    <!-- Search Results Table -->
                    {% if search_results %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Patient Name</th>
                                        <th>DOB</th>
                                        <th>Service Date</th>
                                        <th>CPT Codes</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for result in search_results %}
                                        <tr>
                                            <td>{{ result.order_id }}</td>
                                            <td>{{ result.patient_last_name }}, {{ result.patient_first_name }}</td>
                                            <td>{{ result.patient_dob }}</td>
                                            <td>
                                                {% if result.earliest_dos == result.latest_dos %}
                                                    {{ result.earliest_dos }}
                                                {% else %}
                                                    {{ result.earliest_dos }} to {{ result.latest_dos }}
                                                {% endif %}
                                                {% if result.days_difference != "Unknown" %}
                                                    <br><small class="text-muted">({{ result.days_difference }} from target)</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if result.cpt_codes %}
                                                    <span class="badge bg-info">{{ result.cpt_count }} codes</span>
                                                    <div class="mt-1">
                                                        {% for code in result.cpt_codes %}
                                                            <span class="badge bg-secondary">{{ code }}</span>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">No CPT codes</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <form method="post" action="{% url 'bill_review:map_bill_to_order' bill.id result.order_id %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-primary"
                                                            onclick="return confirm('Map this bill to order {{ result.order_id }}?')">
                                                        Map to Order
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% elif auto_searched %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No matching orders found. Try adjusting the search criteria.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Provider Information -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#providerInfo">
                    Provider Information
                </button>
            </h2>
            <div id="providerInfo" class="accordion-collapse collapse" data-bs-parent="#billAccordion">
                <div class="accordion-body">
                    {% if provider %}
                    <form method="post" action="{% url 'bill_review:update_provider' provider.PrimaryKey bill.id %}">
                        {% csrf_token %}
                        <div class="row">
                            <!-- Practice Information -->
                            <div class="col-md-6">
                                <h5 class="mb-3">Practice Information</h5>
                                <div class="mb-3">
                                    <label class="form-label">DBA Name / Billing Name</label>
                                    <input type="text" name="dba_name" class="form-control" value="{{ provider.DBA_Name_Billing_Name|default:'' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">TIN</label>
                                    <input type="text" name="tin" class="form-control" value="{{ provider.TIN|default:'' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">NPI</label>
                                    <input type="text" name="npi" class="form-control" value="{{ provider.NPI|default:'' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Provider Network</label>
                                    <input type="text" name="network" class="form-control" value="{{ provider.Provider_Network|default:'' }}">
                                </div>
                            </div>

                            <!-- Practice Address -->
                            <div class="col-md-6">
                                <h5 class="mb-3">Practice Address</h5>
                                <div class="mb-3">
                                    <label class="form-label">Address Line 1</label>
                                    <input type="text" name="address1" class="form-control" value="{{ provider.Address_Line_1|default:'' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Address Line 2</label>
                                    <input type="text" name="address2" class="form-control" value="{{ provider.Address_Line_2|default:'' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">City</label>
                                    <input type="text" name="city" class="form-control" value="{{ provider.City|default:'' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">State</label>
                                    <input type="text" name="state" class="form-control" value="{{ provider.State|default:'' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Postal Code</label>
                                    <input type="text" name="postal_code" class="form-control" value="{{ provider.Postal_Code|default:'' }}">
                                </div>
                            </div>

                            <!-- Billing Address -->
                            <div class="col-md-6 mt-4">
                                <h5 class="mb-3">Billing Address</h5>
                                <div class="mb-3">
                                    <label class="form-label">Billing Name</label>
                                    <input type="text" name="billing_name" class="form-control" value="{{ provider.Billing_Name|default:'' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Billing Address Line 1</label>
                                    <input type="text" name="billing_address1" class="form-control" value="{{ provider.Billing_Address_1|default:'' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Billing Address Line 2</label>
                                    <input type="text" name="billing_address2" class="form-control" value="{{ provider.Billing_Address_2|default:'' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Billing City</label>
                                    <input type="text" name="billing_city" class="form-control" value="{{ provider.Billing_Address_City|default:'' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Billing State</label>
                                    <input type="text" name="billing_state" class="form-control" value="{{ provider.Billing_Address_State|default:'' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Billing Postal Code</label>
                                    <input type="text" name="billing_postal_code" class="form-control" value="{{ provider.Billing_Address_Postal_Code|default:'' }}">
                                </div>
                            </div>

                            <!-- Contact Information -->
                            <div class="col-md-6 mt-4">
                                <h5 class="mb-3">Contact Information</h5>
                                <div class="mb-3">
                                    <label class="form-label">Phone</label>
                                    <input type="text" name="phone" class="form-control" value="{{ provider.Phone|default:'' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Fax Number</label>
                                    <input type="text" name="fax" class="form-control" value="{{ provider.Fax_Number|default:'' }}">
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle"></i> Updating provider information will reset this bill to MAPPED status for reprocessing.
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Update Provider</button>
                    </form>
                    {% else %}
                    <p class="text-muted">No provider information available</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Order Information -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#orderInfo">
                    Order Information
                </button>
            </h2>
            <div id="orderInfo" class="accordion-collapse collapse" data-bs-parent="#billAccordion">
                <div class="accordion-body">
                    {% if order %}
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">Order ID</dt>
                                <dd class="col-sm-8">{{ order.Order_ID }}</dd>

                                <dt class="col-sm-4">Bundle Type</dt>
                                <dd class="col-sm-8">{{ order.bundle_type }}</dd>

                                <dt class="col-sm-4">Order Date</dt>
                                <dd class="col-sm-8">{{ order.Order_Date|date:"Y-m-d" }}</dd>

                                <dt class="col-sm-4">Patient ID</dt>
                                <dd class="col-sm-8">{{ order.Patient_ID }}</dd>

                                <dt class="col-sm-4">Provider ID</dt>
                                <dd class="col-sm-8">{{ order.provider_id }}</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <h5>Order Line Items</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Line #</th>
                                            <th>CPT</th>
                                            <th>Category</th>
                                            <th>Modifier</th>
                                            <th>Units</th>
                                            <th>Charge</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in order_items %}
                                        <tr>
                                            <td>{{ item.line_number }}</td>
                                            <td>{{ item.CPT }}</td>
                                            <td>{% if item.CPT in cpt_categories %}{{ cpt_categories.item.CPT.category }}{% endif %}</td>
                                            <td>{{ item.modifier|default:"-" }}</td>
                                            <td>{{ item.units }}</td>
                                            <td>${{ item.charge_amount }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted">No order information available</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Rate Correction -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#rateCorrection">
                    Rate Correction
                </button>
            </h2>
            <div id="rateCorrection" class="accordion-collapse collapse" data-bs-parent="#billAccordion">
                <div class="accordion-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>CPT Code</th>
                                    <th>Modifier</th>
                                    <th>Current Charge</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in bill_items %}
                                <tr>
                                    <td>{{ item.cpt_code }}</td>
                                    <td>{{ item.modifier|default:"-" }}</td>
                                    <td>${{ item.charge_amount }}</td>
                                    <td>
                                        {% if provider_network == "Out of Network" %}
                                            <a href="{% url 'bill_review:add_ota_rate' bill.id item.id %}" class="btn btn-sm btn-primary">Add OTA Rate</a>
                                        {% elif provider_network == "In Network" %}
                                            <a href="{% url 'bill_review:add_ppo_rate' bill.id item.id %}" class="btn btn-sm btn-primary">Add PPO Rate</a>
                                        {% else %}
                                            <span class="text-muted">Network status unknown</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Line Items -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#lineItemsComparison">
                    <i class="fas fa-balance-scale me-2"></i>Line Items Comparison
                    {% if billed_not_ordered or ordered_not_billed %}
                        <span class="badge bg-warning text-dark ms-2">Discrepancies Found</span>
                    {% else %}
                        <span class="badge bg-success ms-2">Items Match</span>
                    {% endif %}
                </button>
            </h2>
            <div id="lineItemsComparison" class="accordion-collapse collapse show" data-bs-parent="#billAccordion">
                <div class="accordion-body">
                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card text-center h-100 border-primary">
                                <div class="card-body">
                                    <h5 class="card-title text-primary">
                                        <i class="fas fa-file-invoice me-2"></i>Bill Items
                                    </h5>
                                    <h3 class="text-primary">{{ bill_items|length }}</h3>
                                    <p class="card-text">Total CPT codes billed</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center h-100 border-info">
                                <div class="card-body">
                                    <h5 class="card-title text-info">
                                        <i class="fas fa-clipboard-list me-2"></i>Order Items
                                    </h5>
                                    <h3 class="text-info">{{ order_items|length }}</h3>
                                    <p class="card-text">Total CPT codes ordered</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center h-100 {% if exact_matches %}border-success{% else %}border-warning{% endif %}">
                                <div class="card-body">
                                    <h5 class="card-title {% if exact_matches %}text-success{% else %}text-warning{% endif %}">
                                        <i class="fas fa-check-double me-2"></i>Exact Matches
                                    </h5>
                                    <h3 class="{% if exact_matches %}text-success{% else %}text-warning{% endif %}">{{ exact_matches|length }}</h3>
                                    <p class="card-text">CPT codes that match exactly</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Side-by-Side Comparison Table -->
                    <div class="row">
                        <div class="col-12">
                            <h5 class="mb-3">
                                <i class="fas fa-columns me-2"></i>Side-by-Side Comparison
                                <span class="text-muted small">(Scroll horizontally to see all columns)</span>
                            </h5>
                            
                            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th colspan="6" class="text-center bg-primary text-white">
                                                <i class="fas fa-file-invoice me-2"></i>BILLED ITEMS
                                            </th>
                                            <th colspan="6" class="text-center bg-info text-white">
                                                <i class="fas fa-clipboard-list me-2"></i>ORDERED ITEMS
                                            </th>
                                            <th rowspan="2" class="text-center bg-secondary text-white align-middle">
                                                <i class="fas fa-balance-scale me-1"></i>Match Status
                                            </th>
                                        </tr>
                                        <tr>
                                            <!-- Bill columns -->
                                            <th class="bg-primary text-white">CPT Code</th>
                                            <th class="bg-primary text-white">Category</th>
                                            <th class="bg-primary text-white">Modifier</th>
                                            <th class="bg-primary text-white">Units</th>
                                            <th class="bg-primary text-white">Charge</th>
                                            <th class="bg-primary text-white">Date</th>
                                            
                                            <!-- Order columns -->
                                            <th class="bg-info text-white">CPT Code</th>
                                            <th class="bg-info text-white">Category</th>
                                            <th class="bg-info text-white">Modifier</th>
                                            <th class="bg-info text-white">Units</th>
                                            <th class="bg-info text-white">Charge</th>
                                            <th class="bg-info text-white">Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% load bill_review_extras %}
                                        {% for item in comparison_data %}
                                        <tr class="{% if item.match_type == 'exact' %}table-success
                                                  {% elif item.match_type == 'category' %}table-warning
                                                  {% elif item.match_type == 'bill_only' %}table-danger
                                                  {% elif item.match_type == 'order_only' %}table-info
                                                  {% else %}table-light{% endif %}">
                                            
                                            <!-- Bill Item Columns -->
                                            <td class="fw-bold">
                                                {% if item.bill_item %}
                                                    {{ item.bill_item.cpt_code }}
                                                    {% if item.bill_item.cpt_code|is_ancillary:ancillary_codes %}
                                                        <span class="badge bg-secondary ms-1">Ancillary</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if item.bill_item %}
                                                    <div class="small">
                                                        <strong>{{ cpt_categories|get_category:item.bill_item.cpt_code }}</strong>
                                                        <br>
                                                        <span class="text-muted">{{ cpt_categories|get_subcategory:item.bill_item.cpt_code }}</span>
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if item.bill_item %}
                                                    {{ item.bill_item.modifier|default:"-" }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if item.bill_item %}
                                                    {{ item.bill_item.units }}
                                                    {% if item.bill_item.units > 1 and not item.bill_item.cpt_code|is_ancillary:ancillary_codes %}
                                                        <i class="fas fa-exclamation-triangle text-warning ms-1" title="Multiple units"></i>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if item.bill_item %}
                                                    ${{ item.bill_item.charge_amount|floatformat:2 }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if item.bill_item %}
                                                    {{ item.bill_item.date_of_service }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            
                                            <!-- Order Item Columns -->
                                            <td class="fw-bold">
                                                {% if item.order_item %}
                                                    {{ item.order_item.CPT }}
                                                    {% if item.order_item.CPT|is_ancillary:ancillary_codes %}
                                                        <span class="badge bg-secondary ms-1">Ancillary</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if item.order_item %}
                                                    <div class="small">
                                                        <strong>{{ cpt_categories|get_category:item.order_item.CPT }}</strong>
                                                        <br>
                                                        <span class="text-muted">{{ cpt_categories|get_subcategory:item.order_item.CPT }}</span>
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if item.order_item %}
                                                    {{ item.order_item.modifier|default:"-" }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if item.order_item %}
                                                    {{ item.order_item.units|default:"1" }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if item.order_item %}
                                                    ${{ item.order_item.Charge|floatformat:2|default:"0.00" }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if item.order_item %}
                                                    {{ item.order_item.DOS }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            
                                            <!-- Match Status Column -->
                                            <td class="text-center">
                                                {% if item.match_type == 'exact' %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check me-1"></i>Exact Match
                                                    </span>
                                                {% elif item.match_type == 'category' %}
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="fas fa-adjust me-1"></i>Category Match
                                                    </span>
                                                {% elif item.match_type == 'bill_only' %}
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-plus me-1"></i>Billed Only
                                                    </span>
                                                {% elif item.match_type == 'order_only' %}
                                                    <span class="badge bg-info">
                                                        <i class="fas fa-minus me-1"></i>Ordered Only
                                                    </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="13" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle me-2"></i>No line items to compare
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-info-circle me-2"></i>Legend
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <span class="badge bg-success me-2">Exact Match</span>
                                            <small>CPT codes match exactly</small>
                                        </div>
                                        <div class="col-md-3">
                                            <span class="badge bg-warning text-dark me-2">Category Match</span>
                                            <small>Same category, different CPT</small>
                                        </div>
                                        <div class="col-md-3">
                                            <span class="badge bg-danger me-2">Billed Only</span>
                                            <small>Billed but not ordered</small>
                                        </div>
                                        <div class="col-md-3">
                                            <span class="badge bg-info me-2">Ordered Only</span>
                                            <small>Ordered but not billed</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary btn-sm" onclick="highlightDiscrepancies()">
                                    <i class="fas fa-highlight me-1"></i>Highlight Discrepancies
                                </button>
                                <button type="button" class="btn btn-success btn-sm" onclick="exportComparison()">
                                    <i class="fas fa-download me-1"></i>Export Comparison
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bill Line Items (Editable) -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#billLineItems">
                    <i class="fas fa-edit me-2"></i>Bill Line Items
                </button>
            </h2>
            <div id="billLineItems" class="accordion-collapse collapse" data-bs-parent="#billAccordion">
                <div class="accordion-body">
                    <!-- Add New Line Item Button -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Line Items</h5>
                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addLineItemModal">
                            <i class="fas fa-plus me-1"></i>Add New Line Item
                        </button>
                    </div>

                    <!-- Desktop Table View -->
                    <div class="table-responsive d-none d-md-block">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>CPT Code</th>
                                    <th>Category</th>
                                    <th>Modifier</th>
                                    <th>Units</th>
                                    <th>Charge Amount</th>
                                    <th>Allowed Amount</th>
                                    <th>In-Network Rate</th>
                                    <th>Out-Network Rate</th>
                                    <th>Decision</th>
                                    <th>Reason</th>
                                    <th>PLOS</th>
                                    <th>Date of Service</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in bill_items %}
                                <tr>
                                    <td>{{ item.cpt_code }}</td>
                                    <td>{% if item.cpt_code in cpt_categories %}{{ cpt_categories|get_category:item.cpt_code }}{% endif %}</td>
                                    <td>{{ item.modifier|default:"-" }}</td>
                                    <td>{{ item.units }}</td>
                                    <td>${{ item.charge_amount }}</td>
                                    <td>${{ item.allowed_amount|default:"-" }}</td>
                                    <td>${{ in_network_rates|get_item:item.cpt_code|default:"-" }}</td>
                                    <td>${{ out_network_rates|get_item:item.cpt_code|default:"-" }}</td>
                                    <td>
                                        <span class="badge {% if item.decision == 'approved' %}bg-success{% elif item.decision == 'denied' %}bg-danger{% else %}bg-secondary{% endif %}">
                                            {{ item.decision }}
                                        </span>
                                    </td>
                                    <td>{{ item.reason_code|default:"-" }}</td>
                                    <td>{{ item.place_of_service|default:"-" }}</td>
                                    <td>{% if item.date_of_service %}{% if item.date_of_service|date:"Y-m-d" != "None" %}{{ item.date_of_service|date:"M d, Y" }}{% else %}{{ item.date_of_service }}{% endif %}{% else %}-{% endif %}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editLineItem{{ item.id }}">
                                                Edit
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteLineItem{{ item.id }}">
                                                Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Edit Line Item Modal -->
                                <div class="modal fade" id="editLineItem{{ item.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Edit Line Item - {{ item.cpt_code }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <form method="post" action="{% url 'bill_review:line_item_update' item.id %}">
                                                {% csrf_token %}
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label">CPT Code *</label>
                                                                <input type="text" name="cpt_code" class="form-control" value="{{ item.cpt_code }}" required>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Modifier</label>
                                                                <input type="text" name="modifier" class="form-control" value="{{ item.modifier|default:'' }}" placeholder="Optional modifier">
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Units *</label>
                                                                <input type="number" name="units" class="form-control" value="{{ item.units }}" min="1" required>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Place of Service</label>
                                                                <input type="text" name="place_of_service" class="form-control" value="{{ item.place_of_service|default:'' }}" placeholder="e.g., 11 (Office)">
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Date of Service *</label>
                                                                <input type="date" name="date_of_service" class="form-control" value="{{ item.date_of_service|default:'' }}" required>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label">Charge Amount *</label>
                                                                <input type="number" step="0.01" name="charge_amount" class="form-control" value="{{ item.charge_amount }}" required>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Allowed Amount</label>
                                                                <input type="number" step="0.01" name="allowed_amount" class="form-control" value="{{ item.allowed_amount|default:'' }}" placeholder="0.00">
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Decision *</label>
                                                                <select name="decision" class="form-select" required>
                                                                    <option value="pending" {% if item.decision == 'pending' %}selected{% endif %}>Pending</option>
                                                                    <option value="approved" {% if item.decision == 'approved' %}selected{% endif %}>Approved</option>
                                                                    <option value="denied" {% if item.decision == 'denied' %}selected{% endif %}>Denied</option>
                                                                </select>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Reason Code</label>
                                                                <input type="text" name="reason_code" class="form-control" value="{{ item.reason_code|default:'' }}" placeholder="Optional reason code">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Delete Line Item Modal -->
                                <div class="modal fade" id="deleteLineItem{{ item.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Delete Line Item</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p>Are you sure you want to delete this line item?</p>
                                                <p><strong>CPT Code:</strong> {{ item.cpt_code }}</p>
                                                <p><strong>Charge Amount:</strong> ${{ item.charge_amount }}</p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <form method="post" action="{% url 'bill_review:line_item_delete' item.id %}">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-danger">Delete</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile Card View -->
                    <div class="d-md-none">
                        {% for item in bill_items %}
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">{{ item.cpt_code }}</h6>
                                <span class="badge {% if item.decision == 'approved' %}bg-success{% elif item.decision == 'denied' %}bg-danger{% else %}bg-secondary{% endif %}">
                                    {{ item.decision }}
                                </span>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Category</small>
                                        <p class="mb-2">{% if item.cpt_code in cpt_categories %}{{ cpt_categories|get_category:item.cpt_code }}{% else %}-{% endif %}</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Modifier</small>
                                        <p class="mb-2">{{ item.modifier|default:"-" }}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Units</small>
                                        <p class="mb-2">{{ item.units }}</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">PLOS</small>
                                        <p class="mb-2">{{ item.place_of_service|default:"-" }}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Date of Service</small>
                                        <p class="mb-2">{% if item.date_of_service %}{% if item.date_of_service|date:"Y-m-d" != "None" %}{{ item.date_of_service|date:"M d, Y" }}{% else %}{{ item.date_of_service }}{% endif %}{% else %}-{% endif %}</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Decision</small>
                                        <p class="mb-2">
                                            <span class="badge {% if item.decision == 'approved' %}bg-success{% elif item.decision == 'denied' %}bg-danger{% else %}bg-secondary{% endif %}">
                                                {{ item.decision }}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Charge Amount</small>
                                        <p class="mb-2">${{ item.charge_amount }}</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Allowed Amount</small>
                                        <p class="mb-2">${{ item.allowed_amount|default:"-" }}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">In-Network Rate</small>
                                        <p class="mb-2">${{ in_network_rates|get_item:item.cpt_code|default:"-" }}</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Out-Network Rate</small>
                                        <p class="mb-2">${{ out_network_rates|get_item:item.cpt_code|default:"-" }}</p>
                                    </div>
                                </div>
                                {% if item.reason_code %}
                                <div class="row">
                                    <div class="col-12">
                                        <small class="text-muted">Reason</small>
                                        <p class="mb-2">{{ item.reason_code }}</p>
                                    </div>
                                </div>
                                {% endif %}
                                <div class="d-flex gap-2 mt-3">
                                    <button type="button" class="btn btn-primary flex-fill" data-bs-toggle="modal" data-bs-target="#editLineItem{{ item.id }}">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </button>
                                    <button type="button" class="btn btn-danger flex-fill" data-bs-toggle="modal" data-bs-target="#deleteLineItem{{ item.id }}">
                                        <i class="fas fa-trash me-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle me-2"></i>No line items found
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.table-responsive {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

.comparison-highlight {
    background-color: #fff3cd !important;
    animation: highlight-pulse 2s ease-in-out;
}

@keyframes highlight-pulse {
    0%, 100% { background-color: #fff3cd; }
    50% { background-color: #ffeaa7; }
}

.table-bordered td, .table-bordered th {
    border-width: 1px;
}

.table th {
    font-size: 0.875rem;
    font-weight: 600;
}

.table td {
    font-size: 0.875rem;
    vertical-align: middle;
}

.badge {
    font-size: 0.75rem;
}

.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
}
</style>

<script>
function highlightDiscrepancies() {
    const discrepancyRows = document.querySelectorAll('.table-danger, .table-info');
    discrepancyRows.forEach(row => {
        row.classList.add('comparison-highlight');
        setTimeout(() => {
            row.classList.remove('comparison-highlight');
        }, 3000);
    });
}

function exportComparison() {
    const table = document.querySelector('#lineItemsComparison table');
    const rows = Array.from(table.querySelectorAll('tr'));
    const csv = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        return cells.map(cell => {
            let text = cell.textContent.trim().replace(/\s+/g, ' ');
            return '"' + text.replace(/"/g, '""') + '"';
        }).join(',');
    }).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `bill_comparison_${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
</script>

{% if search_results or auto_searched %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-scroll to search results after page loads
    setTimeout(function() {
        const resultsTable = document.querySelector('#mappingCollapse .table-responsive');
        if (resultsTable) {
            resultsTable.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
    }, 100); // Small delay to ensure accordion is fully expanded
});
</script>
{% endif %}

<!-- Add New Line Item Modal -->
<div class="modal fade" id="addLineItemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Line Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'bill_review:add_line_item' bill.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">CPT Code *</label>
                                <input type="text" name="cpt_code" class="form-control" required 
                                       placeholder="Enter CPT code">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Modifier</label>
                                <input type="text" name="modifier" class="form-control" 
                                       placeholder="Optional modifier">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Units *</label>
                                <input type="number" name="units" class="form-control" value="1" min="1" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Place of Service</label>
                                <input type="text" name="place_of_service" class="form-control" 
                                       placeholder="e.g., 11 (Office)">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Date of Service *</label>
                                <input type="date" name="date_of_service" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Charge Amount *</label>
                                <input type="number" step="0.01" name="charge_amount" class="form-control" 
                                       placeholder="0.00" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Allowed Amount</label>
                                <input type="number" step="0.01" name="allowed_amount" class="form-control" 
                                       placeholder="0.00">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Decision</label>
                                <select name="decision" class="form-select" required>
                                    <option value="pending" selected>Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="reduced">Reduced</option>
                                    <option value="denied">Denied</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Reason Code</label>
                                <input type="text" name="reason_code" class="form-control" 
                                       placeholder="Optional reason code">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Line Item</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}